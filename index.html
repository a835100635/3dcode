<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <!-- import Vue before Element -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
  <!-- import element-ui JavaScript -->
  <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
  <!-- 引入组件库 -->
  <script src="https://unpkg.com/element-ui/lib/index.js"></script>
  <script src="./utils.js"></script>
  <script src="./server/history.json"></script>
  <link rel="stylesheet" href="./index.css"></link>
</head>
<body>
  <div id="app">
    <el-row>
      <el-col :span="24" class="mb4 flex flex-ac">
        <span>百：</span>
        <el-checkbox-group v-model="exclude.hundred" size="mini">
          <el-checkbox-button v-for="(i, index) in 10" :label="index" :key="index">{{i-1}}</el-checkbox-button>
        </el-checkbox-group>
      </el-col>

      <el-col :span="24" class="mb4 flex flex-ac">
        <span>十：</span>
        <el-checkbox-group v-model="exclude.ten" size="mini">
          <el-checkbox-button v-for="(i, index) in 10" :label="index" :key="index">{{i-1}}</el-checkbox-button>
        </el-checkbox-group>
      </el-col>

      <el-col :span="24" class="mb4 flex flex-ac">
        <span>个：</span>
        <el-checkbox-group v-model="exclude.one" size="mini">
          <el-checkbox-button v-for="(i, index) in 10" :label="index" :key="index">{{i-1}}</el-checkbox-button>
        </el-checkbox-group>
      </el-col>
    </el-row>

    <el-row>
      <el-col :span="6" class="mb4 flex flex-ac mr4">
        <span>注数：</span>
        <el-input v-model="count" placeholder="请输入随机数量" size="mini"></el-input>
      </el-col>
      <el-col :span="10" class="mb4 flex flex-ac">
        <el-button type="primary" @click="generate" size="mini">生成</el-button>
        <el-button type="primary" @click="handleClean" size="mini">清空</el-button>
        <el-button type="primary" @click="handlePaste" size="mini" class="mr4">粘贴</el-button>
      </el-col>
    </el-row>

    <p class="pr">
      <el-input type="textarea" :rows="2" placeholder="请输入内容" v-model="combination">
      </el-input>
      <span class="pa after-value-Length" v-if="result.length"> 生成{{ result.length }}注</span>
    </p>

    <p>{{ tip }}</p>

    <div class="mb8">
      <el-checkbox-group v-model="checkedFilter" style="display: contents;">
        <el-checkbox v-for="(i, index) in checkedConfig" :label="i.label" :key="i.label">{{ i.label }}</el-checkbox>
      </el-checkbox-group>
      <el-radio-group v-model="checkedRadio" style="display: contents;" class="ml10">
        <el-radio v-for="(i, index) in radioConfig" :label="i.label" :key="i.label">{{ i.label }}</el-radio>
      </el-radio-group>
    </div>

    <div class="flex flex-ac mb8">
      <p>排除：</p>
      百: &nbsp;
      <el-select class="w80" v-model="hundred" multiple placeholder="输入" size="mini" clearable>
        <el-option v-for="item in numbers" :key="item" :label="item" :value="item">
        </el-option>
      </el-select>
      &nbsp;十: &nbsp;
      <el-select class="w80" v-model="ten" multiple placeholder="输入" size="mini" clearable>
        <el-option v-for="item in numbers" :key="item" :label="item" :value="item">
        </el-option>
      </el-select>
      &nbsp;个: &nbsp;
      <el-select class="w80" v-model="unit" multiple placeholder="输入" size="mini" clearable>
        <el-option v-for="item in numbers" :key="item" :label="item" :value="item">
        </el-option>
      </el-select>
    </div>

    <div>
      <el-button type="primary" @click="handleCopy(afterValue)" size="mini">复制</el-button>
    </div>

    <p class="pr">
      <el-input type="textarea" :rows="3" :value="afterValue">
      </el-input>
      <span class="pa after-value-Length" v-if="afterValueLength">
        剩{{ afterValueLength }}注; {{ ( 980 / afterValueLength  ).toFixed(2) }} 倍
      </span>
    </p>
    <p v-html="startCountTip"></p>

    <el-divider></el-divider>

    <el-divider content-position="left">历史数据</el-divider>

    <div class="mb4">
      <el-button :type="i === pageSize ? 'primary' : 'default'" v-for="i in buttomTypes" :key="i" @click="changePageSize(i)" size="mini">{{ i }}期</el-button>
    </div>

    <div class="flex gap8">
      <div v-for="(i, index) in numbers" :key="index" class="count-item flex flex-column flex-ac flex-sb">
        <div>{{ appearCount[i] }}</div>
        <div class="count-item-data flex1 flex-column-reverse flex">
          <span class="count-item-data-span" :style="{ height: `${appearCount[i] / maxCount * 100}%` }"></span>
        </div>
        <div class="count-item-number">{{ i }}</div>
      </div>
    </div>


    <el-table :data="tableData">
      <el-table-column prop="opendate" label="日期" width="120"></el-table-column>
      <el-table-column prop="number" label="code" width="80"></el-table-column>
      <el-table-column label="类型">
        <el-table-column prop="isGroupThree" label="组三" width="80">
          <template slot-scope="scope">
            {{ scope.row.isGroupThree ? '三' : '' }}
          </template>
        </el-table-column>
        <el-table-column prop="isGroupSix" label="组六" width="80">
          <template slot-scope="scope">
            {{ scope.row.isGroupSix ? '六' : '' }}
          </template>
        </el-table-column>
      </el-table-column>
      <el-table-column prop="lastRepeat" label="300期重复" width="120">
        <template slot-scope="scope">
          {{ scope.row.lastRepeat.isRepeat ? `前${scope.row.lastRepeat.preIndex}期出现` : '' }}
        </template>
      </el-table-column>
      <el-table-column prop="sum" label="和值" width="60"></el-table-column>
      <el-table-column prop="sumOddEven" label="和值单双" width="60"></el-table-column>
      <el-table-column prop="span" label="跨度" width="60"></el-table-column>
    </el-table>

  </div>

  <script>
    const regex = /^(\d{3})(,\d{3})*$/;
    new Vue({
      el: '#app',
      data: function() {
        this.buttomTypes = [10, 50, 100, 200, 300];
        return {
          numbers: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9],
          codes: [],
          count: 600,
          exclude: {
            // 百
            hundred: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9],
            // 十
            ten: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9],
            // 个
            one: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9],
          },
          // 随机结果
          result: [],
          // 生成的结果
          combination: '',

          history: {},
          historyList: [],

          pageNum: 0,
          pageSize: 50,

          tip: '',

          checkedFilter: ['豹子', '组三', '组六'],
          checkedRadio: '不剔除',

          hundred: [],
          ten: [],
          unit: [],
        }
      },
      watch: {
        result() {
          if (!this.result.length) {
            this.combination = '';
            return;
          }
          this.combination = this.result.map((i) => {
            return i.code;
          }).join(',');
        }
      },
      computed: {
        tableData() {
          return this.historyList.slice(this.pageNum * this.pageSize, (this.pageNum + 1) * this.pageSize);
        },
        // 出现的次数
        appearCount({ numbers, tableData }) {
          const obj = {};
          numbers.forEach(i => {
            obj[i] = 0;
          });
          tableData.forEach(i => {
            const number = i.number.split('').filter(i => i !== '' && i.trim()).join('');
            number.split('').forEach(j => {
              obj[j]++;
            });
          });
          return obj;
        },
        maxCount({ appearCount }) {
          return Object.values(appearCount).reduce((a, b) => a > b ? a : b, 0);
        },
        afterValue({ filterConfig, checkedFilter, checkedRadio,result }) {
          let value = [];
          checkedFilter.forEach(i => {
            const filter = filterConfig.find(j => j.label === i);
            if (filter && filter.handle) {
              value.push(...filter.handle(result));
            }
            if (filter && filter.replace) {
              value = filter.replace(value);
            }
          });
          if (checkedRadio !== '不剔除') {
            const filter = filterConfig.find(j => j.label === checkedRadio);
            if (filter && filter.replace) {
              value = filter.replace(value);
            }
          }
          // 排除百位开头
          if (this.hundred.length) {
            value = value.filter(item => !this.hundred.includes(+item.code[0]));
          }
          // 排除十位开头
          if (this.ten.length) {
            value = value.filter(item => !this.ten.includes(+item.code[1]));
          }
          // 排除个位开头
          if (this.unit.length) {
            value = value.filter(item => !this.unit.includes(+item.code[2]));
          }
          return value.map(i => i.code).sort((a, b) => a - b).join(',');
        },
        afterValueLength({ afterValue }) {
          if (!afterValue || !afterValue.length) return 0;
          return afterValue.split(',').length;
        },
        filterResult() {
          return this.result.map(i => i.code).sort((a, b) => a - b).join(',');
        },
        filterConfig({ checkedFilter, checkedRadio, historyList }) {
          return [
            {
              type: 'checkbox',
              initChecked: checkedFilter.includes('豹子'),
              label: '豹子',
              handle: (v) => v.filter(i => i.isLeopard)
            },
            {
              type: 'checkbox',
              initChecked: checkedFilter.includes('组三'),
              label: '组三',
              handle: (v) => v.filter(i => i.isGroupThree)
            },
            {
              type: 'checkbox',
              initChecked: checkedFilter.includes('组六'),
              label: '组六',
              handle: (v) => v.filter(i => i.isGroupSix)
            },
            {
              type: 'radio',
              initChecked: checkedRadio === '不剔除',
              label: '不剔除',
              replace: (v) => v
            },
            {
              type: 'radio',
              initChecked: checkedRadio === '剔除近50期',
              label: '剔除近50期',
              replace: (v) => v.filter(i => !historyList.slice(0, 50).map(i => i.code).includes(i.code))
            },
            {
              type: 'radio',
              initChecked: checkedRadio === '剔除近100期',
              label: '剔除近100期',
              replace: (v) => v.filter(i => !historyList.slice(0, 100).map(i => i.code).includes(i.code))
            },
            {
              type: 'radio',
              initChecked: checkedRadio === '剔除近150期',
              label: '剔除近150期',
              replace: (v) => v.filter(i => !historyList.slice(0, 150).map(i => i.code).includes(i.code))
            },
            {
              type: 'radio',
              initChecked: checkedRadio === '剔除近200期',
              label: '剔除近200期',
              replace: (v) => v.filter(i => !historyList.slice(0, 200).map(i => i.code).includes(i.code))
            },
            {
              type: 'radio',
              initChecked: checkedRadio === '剔除近300期',
              label: '剔除近300期',
              replace: (v) => v.filter(i => !historyList.slice(0, 300).map(i => i.code).includes(i.code))
            }
          ]
        },
        checkedConfig({ filterConfig }) {
          return filterConfig.filter(i => i.type === 'checkbox');
        },
        radioConfig({ filterConfig }) {
          return filterConfig.filter(i => i.type === 'radio');
        },
        startCount({ afterValue, numbers }) {
          if (!afterValue || !afterValue.length) return {};
          const obj = {};
          numbers.forEach(i => {
            obj[i] = 0;
          });
          afterValue.split(',').forEach(i => {
            if (obj[i[0]]) {
              obj[i[0]]++;
            } else {
              obj[i[0]] = 1;
            }
          })
          return obj;
        },
        startCountTip({ startCount }) {
          if (!Object.keys(startCount).length) return '';
          let tip = '';
          Object.keys(startCount).forEach(i => {
            tip += `${i}: ${startCount[i]}注; <br>`;
          })
          return tip;
        }
      },
      created() {
        this.getHistory();
      },
      methods: {

        init() {
          this.combination = '';
          this.result = [];
        },

        generate() {
          this.codes = window.generateThreeDigits(this.exclude);
          this.result = window.generateCombination(this.count, this.codes);
        },

        handleClean() {
          this.init();
        },

        handlePaste() {
          navigator.clipboard.readText().then(text => {
            this.result.length = 0;
            if (regex.test(text)) {
              text = text.split(',');
              this.result = window.generateData(text);
            } else {
              this.$message.error('请粘贴正确的内容');
            }
          });
        },

        handleCopy(v) {
          if (!v) return;
          this.setTip('复制成功');
          navigator.clipboard.writeText(v);
        },

        setTip(text) {
          this.tip = text;
        },

        changePageSize(size) {
          this.pageSize = size;
          this.pageNum = 0;
        },

        getHistory() {
          fetch('./server/history.json')
            .then(response => response.json())
            .then(data => {
              const keys = Object.keys(data);
              const func = ({ number, opendate }, index) => {
                // 截取 300 条
                const value_ = keys.slice(index+1, index+300).map(i => data[i].number);
                // 判断是否重复
                const isRepeat = value_.includes(number);
                return {
                  isRepeat,
                  preIndex: value_.indexOf(number),
                };
              };
              this.history = data;
              this.historyList = keys.map((i, ondex) => {
                return {
                  opendate: data[i].opendate,
                  number: data[i].number,
                  ...window.formatCode(data[i].number),
                  // 上期重复
                  lastRepeat: func(data[i], ondex),
                  // 和值
                  sum: window.formatCode(data[i].number).sum,
                }
              }).sort((a, b) => a.opendate - b.opendate);
            })
        }
      }
    })
  </script>
</body>
</html>